
{% extends "components/layout.html" %}
{% block title %}Edit Post - {{ params["blog_web_name"] }} {% endblock %}

{% block head %}
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Dropzone for file uploads -->
    <link rel="stylesheet" href="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone.css" />
    <style>
        .featured-image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .featured-image-preview:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .featured-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .featured-image-preview .placeholder {
            text-align: center;
            color: #6c757d;
        }
        .character-count {
            font-size: 0.875rem;
            color: #6c757d;
            text-align: right;
            margin-top: 0.25rem;
        }
        .publish-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
        }
        .status-options {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        .status-option {
            flex: 1;
        }
        .status-option input[type="radio"] {
            display: none;
        }
        .status-option label {
            display: block;
            padding: 0.75rem;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .status-option input[type="radio"]:checked + label {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            color: #0d6efd;
            font-weight: 600;
        }
        .schedule-field {
            display: none;
            margin-top: 1rem;
        }
        .btn-group-custom {
            display: flex;
            gap: 0.5rem;
        }
        .btn-group-custom .btn {
            flex: 1;
        }
        .editor-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        #editor {
            min-height: 300px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-0">Edit Post</h1>
                        <p class="text-muted mb-0">Update your blog post</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" id="previewBtn">
                            <i class="bi bi-eye"></i> Preview
                        </button>
                        <button type="button" class="btn btn-primary" id="updatePostBtn">
                            <i class="bi bi-check-lg"></i> Update Post
                        </button>
                    </div>
                </div>

                <form id="editPostForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <label for="postTitle" class="form-label fw-bold">Post Title *</label>
                                <input type="text" class="form-control form-control-lg" value="{{ post.title if post else '' }}" 
                                       id="postTitle" name="title" required placeholder="Enter a compelling title...">
                                <div class="character-count" id="titleCount">0/120 characters</div>
                            </div>

                            <div class="mb-4">
                                <label for="postExcerpt" class="form-label fw-bold">Excerpt *</label>
                                <textarea class="form-control" id="postExcerpt" name="excerpt" 
                                          rows="3" required placeholder="Brief description of your post...">{{ post.excerpt if post else '' }}</textarea>
                                <div class="character-count" id="excerptCount">0/300 characters</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Featured Image</label>
                            <div class="featured-image-preview mb-3" id="imagePreview" onclick="document.getElementById('featuredImage').click()">
                                {% if post and post.thumbnail %}
                                    <img src="{{ url_for('static', filename=post.thumbnail) }}" alt="{{ post.thumbnail }}" id="previewImg">
                                {% else %}
                                    <div class="placeholder">
                                        <i class="bi bi-camera fs-1 mb-2"></i>
                                        <div>Click to upload featured image</div>
                                        <small class="text-muted">JPG, PNG up to 10MB</small>
                                    </div>
                                {% endif %}
                            </div>
                            <input type="file" id="featuredImage" name="featured_image" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="postCategory" class="form-label fw-bold">Category *</label>
                            <select class="form-select" id="postCategory" name="category" required>
                                <option value="">Select a category</option>
                                <option value="technology" {{ 'selected' if post and post.category == 'technology' else '' }}>Technology</option>
                                <option value="lifestyle" {{ 'selected' if post and post.category == 'lifestyle' else '' }}>Lifestyle</option>
                                <option value="business" {{ 'selected' if post and post.category == 'business' else '' }}>Business</option>
                                <option value="education" {{ 'selected' if post and post.category == 'education' else '' }}>Education</option>
                                <option value="health" {{ 'selected' if post and post.category == 'health' else '' }}>Health</option>
                                <option value="travel" {{ 'selected' if post and post.category == 'travel' else '' }}>Travel</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="postSlug" class="form-label fw-bold">URL Slug</label>
                            <input type="text" class="form-control" id="postSlug" name="slug" 
                                   value="{{ post.slug if post else '' }}" placeholder="auto-generated-from-title">
                            <small class="form-text text-muted">Leave blank to auto-generate</small>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="postMeta" class="form-label fw-bold">Meta Description</label>
                        <textarea class="form-control" id="postMeta" name="meta_description" rows="2" 
                                  placeholder="SEO description for search engines...">{{ post.meta_description if post else '' }}</textarea>
                        <div class="character-count" id="metaCount">0/160 characters</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Content *</label>
                        <div class="editor-container">
                            <div id="editor"></div>
                        </div>
                        <textarea id="postContent" name="content" style="display: none;" required>{{ post.content if post else '' }}</textarea>
                    </div>
                </form>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="publish-panel mb-4">
                    <h5 class="mb-3">Publication Status</h5>
                    
                    <div class="status-options">
                        <div class="status-option">
                            <input type="radio" id="statusDraft" name="status" value="draft" 
                                   {{ 'checked' if not post or post.status == 'draft' else '' }}>
                            <label for="statusDraft">
                                <i class="bi bi-file-earmark"></i><br>Draft
                            </label>
                        </div>
                        <div class="status-option">
                            <input type="radio" id="statusPublish" name="status" value="publish"
                                   {{ 'checked' if post and post.status == 'publish' else '' }}>
                            <label for="statusPublish">
                                <i class="bi bi-globe"></i><br>Publish
                            </label>
                        </div>
                        <div class="status-option">
                            <input type="radio" id="statusSchedule" name="status" value="schedule"
                                   {{ 'checked' if post and post.status == 'schedule' else '' }}>
                            <label for="statusSchedule">
                                <i class="bi bi-calendar"></i><br>Schedule
                            </label>
                        </div>
                    </div>

                    <div class="schedule-field" id="scheduleField" style="display: {{ 'block' if post and post.status == 'schedule' else 'none' }}">
                        <label for="publishDate" class="form-label">Publish Date & Time</label>
                        <input type="datetime-local" class="form-control" id="publishDate" name="publish_date"
                               value="{{ post.publish_date.strftime('%Y-%m-%dT%H:%M') if post and post.publish_date else '' }}">
                    </div>

                    <hr class="my-4">
                    
                    <div class="btn-group-custom">
                        <button type="button" class="btn btn-outline-danger" id="deletePostBtn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        <button type="button" class="btn btn-success" id="updatePostBtn2">
                            <i class="bi bi-check-lg"></i> Update
                        </button>
                    </div>
                </div>

                <div class="publish-panel">
                    <h6 class="mb-3">Post Statistics</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="fw-bold" id="wordCount">0</div>
                            <small class="text-muted">Words</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold" id="charCount">0</div>
                            <small class="text-muted">Characters</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold" id="readTime">0</div>
                            <small class="text-muted">Min read</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Quill Rich Text Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- Dropzone for file uploads -->
    <script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>

    <script>
        class EditBlog {
            constructor() {
                this.postId = {{ post.sno if post else 'null' }};
                this.initializeElements();
                this.initializeQuill();
                this.initializeEventListeners();
                this.updateCharacterCounts();
                this.updatePostStats();
            }

            initializeElements() {
                this.postTitle = document.getElementById('postTitle');
                this.postExcerpt = document.getElementById('postExcerpt');
                this.postCategory = document.getElementById('postCategory');
                this.postSlug = document.getElementById('postSlug');
                this.postMeta = document.getElementById('postMeta');
                this.postContent = document.getElementById('postContent');
                this.featuredImage = document.getElementById('featuredImage');
                this.publishDate = document.getElementById('publishDate');
                this.updatePostBtn = document.getElementById('updatePostBtn');
                this.updatePostBtn2 = document.getElementById('updatePostBtn2');
                this.deletePostBtn = document.getElementById('deletePostBtn');
            }

            initializeQuill() {
                this.quill = new Quill('#editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['blockquote', 'code-block'],
                            ['link', 'image', 'video'],
                            ['clean']
                        ]
                    }
                });

                // Set initial content if editing
                {% if post and post.content %}
                this.quill.root.innerHTML = `{{ post.content|safe|replace('\n', '\\n')|replace('\r', '')|replace("'", "\\'")|replace('"', '\\"') }}`;
                {% endif %}

                this.quill.on('text-change', () => {
                    this.postContent.value = this.quill.root.innerHTML;
                    this.updatePostStats();
                });
            }

            initializeEventListeners() {
                // Character count updates
                this.postTitle?.addEventListener('input', () => this.updateCharacterCounts());
                this.postExcerpt?.addEventListener('input', () => this.updateCharacterCounts());
                this.postMeta?.addEventListener('input', () => this.updateCharacterCounts());

                // Auto-generate slug from title
                this.postTitle?.addEventListener('input', (e) => {
                    if (this.postSlug && !this.postSlug.value) {
                        this.postSlug.value = this.generateSlug(e.target.value);
                    }
                });

                // Image preview
                this.featuredImage?.addEventListener('change', (e) => this.previewImage(e));

                // Status change handling
                document.querySelectorAll('input[name="status"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const scheduleField = document.getElementById('scheduleField');
                        scheduleField.style.display = e.target.value === 'schedule' ? 'block' : 'none';
                    });
                });

                // Update post buttons
                this.updatePostBtn?.addEventListener('click', () => this.updatePost());
                this.updatePostBtn2?.addEventListener('click', () => this.updatePost());

                // Delete post button
                this.deletePostBtn?.addEventListener('click', () => this.deletePost());

                // Preview button
                document.getElementById('previewBtn')?.addEventListener('click', () => {
                    alert('Preview functionality would open a new tab with your post preview');
                });
            }

            updateCharacterCounts() {
                const titleCount = document.getElementById('titleCount');
                const excerptCount = document.getElementById('excerptCount');
                const metaCount = document.getElementById('metaCount');

                if (titleCount && this.postTitle) {
                    const length = this.postTitle.value.length;
                    titleCount.textContent = `${length}/120 characters`;
                    titleCount.style.color = length > 120 ? '#dc3545' : '#6c757d';
                }

                if (excerptCount && this.postExcerpt) {
                    const length = this.postExcerpt.value.length;
                    excerptCount.textContent = `${length}/300 characters`;
                    excerptCount.style.color = length > 300 ? '#dc3545' : '#6c757d';
                }

                if (metaCount && this.postMeta) {
                    const length = this.postMeta.value.length;
                    metaCount.textContent = `${length}/160 characters`;
                    metaCount.style.color = length > 160 ? '#dc3545' : '#6c757d';
                }
            }

            updatePostStats() {
                const content = this.quill?.getText() || '';
                const words = content.trim().split(/\s+/).filter(word => word.length > 0).length;
                const characters = content.length;
                const readTime = Math.ceil(words / 200);

                const wordCountEl = document.getElementById('wordCount');
                const charCountEl = document.getElementById('charCount');
                const readTimeEl = document.getElementById('readTime');

                if (wordCountEl) wordCountEl.textContent = words;
                if (charCountEl) charCountEl.textContent = characters;
                if (readTimeEl) readTimeEl.textContent = readTime;
            }

            generateSlug(title) {
                return title.toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }

            previewImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = `<img src="${e.target.result}" alt="Featured image" id="previewImg">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            async updatePost() {
                try {
                    const formData = new FormData();
                    
                    // Add form fields
                    formData.append('title', this.postTitle.value);
                    formData.append('excerpt', this.postExcerpt.value);
                    formData.append('content', this.quill.root.innerHTML);
                    formData.append('category', this.postCategory.value);
                    formData.append('slug', this.postSlug.value);
                    formData.append('meta_description', this.postMeta.value);

                    // Add status
                    const status = document.querySelector('input[name="status"]:checked').value;
                    formData.append('status', status);

                    if (status === 'schedule' && this.publishDate.value) {
                        formData.append('publish_date', this.publishDate.value);
                    }

                    // Add featured image if changed
                    if (this.featuredImage.files[0]) {
                        formData.append('featured_image', this.featuredImage.files[0]);
                    }

                    const response = await fetch(`/api/blogs?id=${this.postId}`, {
                        method: 'PUT',
                        headers: {
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        },
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Post updated successfully!');
                        window.location.href = `/blogs/post/${data.post_slug}`;
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error updating post:', error);
                    alert('An error occurred while updating the post.');
                }
            }

            async deletePost() {
                if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    try {
                        const response = await fetch(`/user/deletePost/${this.postId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                            }
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Post deleted successfully!');
                            window.location.href = '/user/';
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    } catch (error) {
                        console.error('Error deleting post:', error);
                        alert('An error occurred while deleting the post.');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            new EditBlog();
        });
    </script>
{% endblock %}
