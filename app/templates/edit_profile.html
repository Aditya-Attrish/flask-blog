{% extends "components/layout.html" %}
{% block title %}Edit Profile - {{ params["blog_web_name"] }} {% endblock %}

{% block head %}

            <style>
                .profile-container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 2rem;
                }

                .profile-sidebar {
                    position: sticky;
                    top: 100px;
                }

                .avatar-container {
                    text-align: center;
                    padding: 2rem;
                    background: #f8f9fa;
                    border-radius: 15px;
                    margin-bottom: 2rem;
                }

                .avatar-preview {
                    width: 150px;
                    height: 150px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 4px solid white;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                }

                .avatar-upload {
                    position: relative;
                    display: inline-block;
                }

                .avatar-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    cursor: pointer;
                }

                .avatar-upload:hover .avatar-overlay {
                    opacity: 1;
                }

                .nav-pills .nav-link {
                    border-radius: 10px;
                    margin-bottom: 0.5rem;
                    padding: 0.75rem 1rem;
                    color: #6c757d;
                    transition: all 0.3s ease;
                }

                .nav-pills .nav-link.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }

                .nav-pills .nav-link:hover:not(.active) {
                    background: #f8f9fa;
                    color: #495057;
                }

                .section-card {
                    background: white;
                    border-radius: 15px;
                    padding: 2rem;
                    margin-bottom: 2rem;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }

                .social-link-input {
                    position: relative;
                }

                .social-link-input .input-group-text {
                    background: #f8f9fa;
                    border-right: none;
                }

                .social-link-input .form-control {
                    border-left: none;
                }

                .char-count {
                    font-size: 0.875rem;
                    color: #6c757d;
                }

                .char-count.warning {
                    color: #fd7e14;
                }

                .char-count.danger {
                    color: #dc3545;
                }
            </style>
{% endblock %}
{% block body %}
            <div class="profile-container">
                <div class="row">
                    <!-- Sidebar -->
                    <div class="col-lg-3">
                        <div class="profile-sidebar">
                            <!-- Avatar Section -->
                            <div class="avatar-container">
                                <div class="avatar-upload">
                                    <img src="{{ url_for('static', filename=current_user.avatar) }}" 
                                         alt="Profile Picture" 
                                         class="avatar-preview"
                                         id="avatarPreview">
                                    <div class="avatar-overlay" id="avatarOverlay">
                                        <i class="bi bi-camera text-white fs-4"></i>
                                    </div>
                                </div>
                                <input type="file" id="avatarInput" accept="image/*" class="d-none">

                                <h5 class="mt-3 mb-1">{{ current_user.full_name }}</h5>
                                <p class="text-muted mb-2">@{{ current_user.username }}</p>

                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('avatarInput').click()">
                                        <i class="bi bi-upload"></i> Change
                                    </button>
                                    {% if "default-user.jpg" not in current_user.avatar %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAvatar()">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Navigation -->
                            <ul class="nav nav-pills flex-column">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#personal" data-bs-toggle="tab">
                                        <i class="bi bi-person me-2"></i>Personal Info
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#social" data-bs-toggle="tab">
                                        <i class="bi bi-share me-2"></i>Social Links
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#preferences" data-bs-toggle="tab">
                                        <i class="bi bi-gear me-2"></i>Preferences
                                    </a>
                                </li>
                            </ul>

                            <!-- Stats -->
                            <div class="mt-4 p-3 bg-light rounded">
                                <h6 class="fw-bold">Profile Stats</h6>
                                <div class="d-flex justify-content-between">
                                    <span>Posts:</span>
                                    <strong>{{ current_user.posts | length }}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Member since:</span>
                                    <strong>{{ current_user.created_at.strftime('%b %Y') }}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Last active:</span>
                                    <strong>{{ current_user.last_seen.strftime('%b %d, %Y') if current_user.last_seen else 'Recently' }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-bold">Edit Profile</h2>
                            <a href="{{ url_for('user.profile', username=current_user.username) }}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-eye"></i> View Public Profile
                            </a>
                        </div>

                        <!-- Flash Messages -->
                        {% include 'components/message.html' %}

                        <form method="POST" enctype="multipart/form-data" id="profileForm">
                            {{ form.hidden_tag() }}

                            <div class="tab-content">
                                <!-- Personal Information Tab -->
                                <div class="tab-pane fade show active" id="personal">
                                    <div class="section-card">
                                        <h4 class="fw-bold mb-4">
                                            <i class="bi bi-person me-2"></i>Personal Information
                                        </h4>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">First Name</label>
                                                    {{ form.first_name(class="form-control", placeholder="John") }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Last Name</label>
                                                    {{ form.last_name(class="form-control", placeholder="Doe") }}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Bio</label>
                                            {{ form.bio(class="form-control", rows="4", 
                                                      placeholder="Tell us about yourself...") }}
                                            <div class="char-count" id="bioCharCount">0/500 characters</div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Location</label>
                                                    {{ form.location(class="form-control", placeholder="City, Country") }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Website</label>
                                                    {{ form.website(class="form-control", placeholder="https://example.com") }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Social Links Tab -->
                                <div class="tab-pane fade" id="social">
                                    <div class="section-card">
                                        <h4 class="fw-bold mb-4">
                                            <i class="bi bi-share me-2"></i>Social Links
                                        </h4>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Twitter</label>
                                            <div class="social-link-input">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-twitter text-primary"></i>
                                                    </span>
                                                    {{ form.twitter_url(class="form-control", placeholder="https://twitter.com/username") }}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">LinkedIn</label>
                                            <div class="social-link-input">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-linkedin text-primary"></i>
                                                    </span>
                                                    {{ form.linkedin_url(class="form-control", placeholder="https://linkedin.com/in/username") }}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">GitHub</label>
                                            <div class="social-link-input">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-github"></i>
                                                    </span>
                                                    {{ form.github_url(class="form-control", placeholder="https://github.com/username") }}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Instagram</label>
                                            <div class="social-link-input">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-instagram text-danger"></i>
                                                    </span>
                                                    {{ form.instagram_url(class="form-control", placeholder="https://instagram.com/username") }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preferences Tab -->
                                <div class="tab-pane fade" id="preferences">
                                    <div class="section-card">
                                        <h4 class="fw-bold mb-4">
                                            <i class="bi bi-gear me-2"></i>Preferences
                                        </h4>

                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.newsletter(class="form-check-input") }}
                                                <label class="form-check-label fw-bold">
                                                    Subscribe to newsletter
                                                </label>
                                                <div class="form-text">
                                                    Receive updates about new features and content
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.public_profile(class="form-check-input") }}
                                                <label class="form-check-label fw-bold">
                                                    Public profile
                                                </label>
                                                <div class="form-text">
                                                    Allow others to view your profile and posts
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.email_notifications(class="form-check-input") }}
                                                <label class="form-check-label fw-bold">
                                                    Email notifications
                                                </label>
                                                <div class="form-text">
                                                    Receive email notifications for comments and interactions
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('user.admin') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Update Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
{% endblock %}
{% block scripts %}
            <script>
                class ProfileEditor {
                    constructor() {
                        this.init();
                    }

                    init() {
                        this.setupEventListeners();
                        this.setupCharacterCounters();
                        this.setupAvatarUpload();
                    }

                    setupEventListeners() {
                        // Tab switching
                        const tabLinks = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
                        tabLinks.forEach(link => {
                            link.addEventListener('shown.bs.tab', (e) => {
                                // Save active tab to localStorage
                                localStorage.setItem('activeProfileTab', e.target.getAttribute('href'));
                            });
                        });

                        // Restore active tab
                        const activeTab = localStorage.getItem('activeProfileTab');
                        if (activeTab) {
                            const tab = document.querySelector(`[href="${activeTab}"]`);
                            if (tab) {
                                new bootstrap.Tab(tab).show();
                            }
                        }

                        // Form submission
                        document.getElementById('profileForm').addEventListener('submit', (e) => {
                            this.showLoadingState();
                        });
                    }

                    setupCharacterCounters() {
                        const bioTextarea = document.getElementById('bio');
                        const charCount = document.getElementById('bioCharCount');

                        if (bioTextarea && charCount) {
                            // Set initial count
                            charCount.textContent = `${bioTextarea.value.length}/500 characters`;

                            bioTextarea.addEventListener('input', () => {
                                const length = bioTextarea.value.length;
                                charCount.textContent = `${length}/500 characters`;

                                if (length > 450) {
                                    charCount.className = 'char-count warning';
                                } else if (length > 500) {
                                    charCount.className = 'char-count danger';
                                } else {
                                    charCount.className = 'char-count';
                                }
                            });
                        }
                    }

                    setupAvatarUpload() {
                        const avatarInput = document.getElementById('avatarInput');
                        const avatarPreview = document.getElementById('avatarPreview');

                        avatarInput.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                this.uploadAvatar(file);
                            }
                        });
                    }

                    async uploadAvatar(file) {
                        const formData = new FormData();
                        formData.append('avatar', file);

                        try {
                            const response = await fetch('/api/profile/avatar', {
                                method: 'POST',
                                headers: {
                                    'X-CSRF-Token': this.getCSRFToken()
                                },
                                body: formData
                            });

                            const result = await response.json();

                            if (result.success) {
                                // Update avatar preview
                                document.getElementById('avatarPreview').src = result.avatar_url;
                                this.showAlert('Avatar updated successfully!', 'success');
                            } else {
                                this.showAlert(result.message, 'danger');
                            }
                        } catch (error) {
                            console.error('Avatar upload error:', error);
                            this.showAlert('Error uploading avatar', 'danger');
                        }
                    }

                    showLoadingState() {
                        const submitBtn = document.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Updating...';
                        submitBtn.disabled = true;

                        // Revert after 5 seconds (fallback)
                        setTimeout(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }, 5000);
                    }

                    getCSRFToken() {
                        return document.querySelector('[name=csrf_token]').value;
                    }

                    showAlert(message, type) {
                        const alert = document.createElement('div');
                        alert.className = `alert alert-${type} alert-dismissible fade show`;
                        alert.innerHTML = `
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                        document.querySelector('.profile-container').prepend(alert);

                        setTimeout(() => {
                            alert.remove();
                        }, 5000);
                    }
                }

                async function deleteAvatar() {
                    if (!confirm('Are you sure you want to remove your profile picture?')) {
                        return;
                    }

                    try {
                        const response = await fetch('/profile/delete-avatar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': document.querySelector('[name=csrf_token]').value
                            }
                        });

                        if (response.ok) {
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Error deleting avatar:', error);
                    }
                }

                // Initialize profile editor
                document.addEventListener('DOMContentLoaded', function() {
                    window.profileEditor = new ProfileEditor();
                });
            </script>
       
{% endblock %}